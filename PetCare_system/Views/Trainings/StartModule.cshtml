@model PetCare_system.Models.TrainingSessionViewModel

@{
    ViewBag.Title = "Training: " + Model.Module.Title;
}

<div class="container mt-4">
    <div class="card shadow">
        <div class="card-header bg-primary text-white">
            <h3>@Model.Module.Title</h3>
            <p>@Model.Module.Description</p>
        </div>

        <div class="card-body">
            <div class="row">
                <div class="col-md-8">
                    <!-- Video Section -->
                    <div class="mb-4">
                        <h4>Training Videos</h4>
                        <div class="list-group mb-3">
                            @foreach (var video in Model.Videos)
                            {
                                var isWatched = Model.Progress.VideosWatched > Model.Videos.IndexOf(video);
                                <a href="#" class="list-group-item list-group-item-action video-item d-flex justify-content-between align-items-center @(isWatched ? "list-group-item-success" : "")"
                                   data-videoid="@video.Id"
                                   data-url="@video.VideoUrl"
                                   data-type="video/mp4">
                                    <div>
                                        <i class="fas @(isWatched ? "fa-check-circle text-success" : "fa-play-circle text-primary") me-2"></i>
                                        <span>@video.Title</span>
                                    </div>
                                    <span class="badge bg-secondary rounded-pill">@video.DurationMinutes min</span>
                                </a>
                            }
                        </div>

                        <div class="ratio ratio-16x9 mb-3 position-relative" id="videoContainer">
                            <video id="trainingVideo" controls class="w-100" playsinline>
                                Your browser doesn't support HTML5 video.
                            </video>
                            <div id="videoPlayOverlay" class="video-play-overlay d-none">
                                <i class="fas fa-play-circle"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Quiz Section -->
                    <div id="quizSection" class="mb-4 @(Model.Progress.VideosWatched >= Model.Videos.Count ? "" : "d-none")">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h4 class="mb-0">Module Quiz</h4>
                            <span class="badge bg-success">Ready to Attempt</span>
                        </div>

                        @if (Model.QuizQuestions != null && Model.QuizQuestions.Count > 0)
                        {
                            using (Html.BeginForm("SubmitQuiz", "TrainingContent", FormMethod.Post, new { id = "quizForm" }))
                            {
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="PetId" value="@Model.PetId" />
                                <input type="hidden" name="ModuleId" value="@Model.Module.Id" />

                                for (int i = 0; i < Model.QuizQuestions.Count; i++)
                                {
                                    <div class="card mb-3">
                                        <div class="card-body">
                                            <h5 class="card-title">@Model.QuizQuestions[i].QuestionText</h5>
                                            <input type="hidden" name="Answers[@i].QuestionId" value="@Model.QuizQuestions[i].Id" />

                                            <div class="list-group">
                                                @foreach (var option in Model.QuizQuestions[i].Options)
                                                {
                                                    <div class="list-group-item">
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="radio"
                                                                   name="Answers[@i].SelectedOptionId"
                                                                   id="option-@option.Id"
                                                                   value="@option.Id" required>
                                                            <label class="form-check-label w-100" for="option-@option.Id">
                                                                @option.OptionText
                                                            </label>
                                                        </div>
                                                    </div>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                }

                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-paper-plane"></i> Submit Quiz
                                </button>
                            }
                        }
                        else
                        {
                            <div class="alert alert-warning">
                                No quiz questions available for this module.
                            </div>
                        }
                    </div>
                </div>

                <div class="col-md-4">
                    <!-- Progress Section -->
                    <div class="card mb-4">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0">Progress</h5>
                        </div>
                        <div class="card-body">
                            <div class="progress mb-3" style="height: 25px;">
                                <div class="progress-bar" role="progressbar"
                                     style="width: @Model.Progress.Progress%; background-color: @(Model.Progress.VideosWatched >= Model.Videos.Count ? "#28a745" : "#17a2b8")">
                                    @Model.Progress.Progress%
                                </div>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>Videos watched:</span>
                                <span><span id="videosWatchedCount">@Model.Progress.VideosWatched</span>/<span id="totalVideosCount">@Model.Videos.Count</span></span>
                            </div>

                            @if (Model.Progress.VideosWatched >= Model.Videos.Count)
                            {
                                <div class="alert alert-success mt-3 mb-0">
                                    <i class="fas fa-check-circle"></i> You can now attempt the quiz!
                                </div>
                            }
                            else
                            {
                                <div class="alert alert-info mt-3 mb-0">
                                    <i class="fas fa-info-circle"></i> Watch the video to unlock the quiz
                                </div>
                            }
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="card">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">Quick Actions</h5>
                        </div>
                        <div class="list-group list-group-flush">
                            <a href="@Url.Action("ModuleVideos", "TrainingContent", new { id = Model.Module.Id })"
                               class="list-group-item list-group-item-action">
                                <i class="fas fa-video me-2"></i> View All Videos
                            </a>
                            <a href="@Url.Action("PetProgress", "Training", new { petId = Model.PetId })"
                               class="list-group-item list-group-item-action">
                                <i class="fas fa-chart-line me-2"></i> View Progress
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
@section Scripts {
    <script>
        $(document).ready(function() {
            // Tracked videos
            const trackedVideos = new Set();
            let currentVideoId = 0;
            const videoPlayer = document.getElementById('trainingVideo');
            const videoOverlay = document.getElementById('videoPlayOverlay');
            const totalVideos = @Model.Videos.Count;
            let errorAlertVisible = false;
            let isNetworkError = false;

            // Video player functionality
            $('.video-item').click(function(e) {
                e.preventDefault();
                const videoUrl = $(this).data('url');
                const videoType = $(this).data('type') || 'video/mp4';
                currentVideoId = $(this).data('videoid');
                const $item = $(this);

                // Reset error states
                errorAlertVisible = false;
                isNetworkError = false;

                // Highlight selected video
                $('.video-item').removeClass('active');
                $item.addClass('active');

                // Reset video player
                videoPlayer.pause();
                videoPlayer.currentTime = 0;

                // Clear existing sources
                while (videoPlayer.firstChild) {
                    videoPlayer.removeChild(videoPlayer.firstChild);
                }

                // Create new source element
                const source = document.createElement('source');
                source.src = videoUrl;
                source.type = videoType;
                videoPlayer.appendChild(source);

                // Load the new video
                videoPlayer.load();

                // Show overlay for manual play
                $(videoOverlay).removeClass('d-none');
            });

            // Overlay click handler
            $(videoOverlay).click(function() {
                playVideo();
            });

            function playVideo() {
                const playPromise = videoPlayer.play();

                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        $(videoOverlay).addClass('d-none');
                    }).catch(error => {
                        console.log("Playback failed:", error);
                        showCustomPlayButton();
                    });
                }
            }

            function showCustomPlayButton() {
                $('#videoContainer').find('.custom-play-button').remove();

                const customPlayButton = $('<button class="btn btn-primary btn-lg custom-play-button"><i class="fas fa-play"></i> Play Video</button>');

                customPlayButton.css({
                    position: 'absolute',
                    top: '50%',
                    left: '50%',
                    transform: 'translate(-50%, -50%)',
                    zIndex: 20
                });

                $('#videoContainer').append(customPlayButton);

                customPlayButton.click(function() {
                    videoPlayer.play()
                        .then(() => {
                            $(videoOverlay).addClass('d-none');
                            customPlayButton.remove();
                        })
                        .catch(error => {
                            console.log("Still can't play:", error);
                        });
                });
            }

            // Video event handlers
            videoPlayer.addEventListener('ended', handleVideoEnded);
            videoPlayer.addEventListener('timeupdate', handleVideoProgress);
            videoPlayer.addEventListener('play', function() {
                $(videoOverlay).addClass('d-none');
            });

            function handleVideoEnded() {
                if (currentVideoId && !trackedVideos.has(currentVideoId)) {
                    trackVideoWatched(currentVideoId);
                }
                $(videoOverlay).removeClass('d-none');
            }

            function handleVideoProgress() {
                if (currentVideoId && !trackedVideos.has(currentVideoId) && videoPlayer.duration > 0) {
                    const percentWatched = (videoPlayer.currentTime / videoPlayer.duration) * 100;
                    if (percentWatched > 90) {
                        trackVideoWatched(currentVideoId);
                    }
                }
            }

            function trackVideoWatched(videoId) {
                trackedVideos.add(videoId);
                const $item = $(`.video-item[data-videoid="${videoId}"]`);

                const originalContent = $item.html();
                $item.html('<i class="fas fa-spinner fa-spin me-2"></i> Saving progress...');

                const trackVideoUrl = '@Url.Action("RecordVideoWatched", "TrainingContent")';

                $.ajax({
                    url: trackVideoUrl,
                    type: 'POST',
                    data: {
                        videoId: videoId,
                        petId: @Model.PetId
                    },
                    success: function(response) {
                        if (response && response.success) {
                            updateProgressUI(response);
                        } else {
                            handleTrackingError($item, originalContent, videoId, response);
                        }
                    },
                    error: function(xhr, status, error) {
                        handleTrackingError($item, originalContent, videoId);
                        isNetworkError = true;
                        checkAllVideosWatched(); // Force check in case of network error
                    }
                });
            }

            function updateProgressUI(response) {
                $('.progress-bar').css({
                    'width': response.progress + '%',
                    'background-color': response.videosWatched >= totalVideos ? '#28a745' : '#17a2b8'
                }).text(response.progress + '%');

                $('#videosWatchedCount').text(response.videosWatched);

                const $item = $(`.video-item[data-videoid="${currentVideoId}"]`);
                $item.find('i').removeClass('fa-play-circle').addClass('fa-check-circle');
                $item.addClass('list-group-item-success');

                checkAllVideosWatched();
            }

            function handleTrackingError($item, originalContent, videoId, response = null) {
                console.error('Tracking error:', response);
                $item.html(originalContent);
                trackedVideos.delete(videoId);

                if (!errorAlertVisible) {
                    const errorMsg = response && response.message
                        ? response.message
                        : 'Progress not saved due to network error. Please check your connection.';
                    showError(errorMsg);
                    errorAlertVisible = true;
                }
            }

            function checkAllVideosWatched() {
                // If network error occurred, assume video was watched locally
                const videosWatched = isNetworkError
                    ? totalVideos
                    : trackedVideos.size;

                if (videosWatched >= totalVideos) {
                    $('#quizSection').removeClass('d-none');
                    $('.progress-bar').css('background-color', '#28a745');

                    const alert = $('<div class="alert alert-success alert-dismissible fade show mt-3">' +
                        '<i class="fas fa-check-circle"></i> Quiz unlocked! Scroll down to attempt.' +
                        '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>' +
                        '</div>');

                    $('.card-body').prepend(alert);
                    setTimeout(() => {
                        alert.alert('close');
                        $('html, body').animate({
                            scrollTop: $('#quizSection').offset().top - 20
                        }, 500);
                    }, 2000);
                }
            }

            function showError(message) {
                $('.alert-dismissible').alert('close');

                const alert = $('<div class="alert alert-danger alert-dismissible fade show mt-3">' +
                    '<i class="fas fa-exclamation-circle"></i> ' + message +
                    '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>' +
                    '</div>');

                $('.card-body').prepend(alert);

                setTimeout(() => {
                    alert.alert('close');
                    errorAlertVisible = false;
                }, 5000);
            }

            // Quiz submission
            $('#quizForm').submit(function(e) {
                e.preventDefault();
                const $submitBtn = $(this).find('button[type="submit"]');
                const $form = $(this);

                const unansweredQuestions = $form.find('.card').filter(function() {
                    return $(this).find('input[type="radio"]:checked').length === 0;
                });

                if (unansweredQuestions.length > 0) {
                    showError('Please answer all questions before submitting.');
                    $('html, body').animate({
                        scrollTop: unansweredQuestions.first().offset().top - 20
                    }, 500);
                    return;
                }

                $submitBtn.prop('disabled', true)
                    .html('<span class="spinner-border spinner-border-sm" role="status"></span> Submitting...');

                $.ajax({
                    url: $form.attr('action'),
                    type: 'POST',
                    data: $form.serialize(),
                    success: function(response) {
                        if (response && response.success) {
                            showQuizSuccess(response);
                        } else {
                            showError(response && response.message
                                ? response.message
                                : 'Quiz submission failed. Please try again.');
                        }
                    },
                    error: function(xhr) {
                        showError(xhr.responseJSON && xhr.responseJSON.message
                            ? xhr.responseJSON.message
                            : 'Error submitting quiz. Please try again.');
                    },
                    complete: function() {
                        $submitBtn.prop('disabled', false)
                            .html('<i class="fas fa-paper-plane"></i> Submit Quiz');
                    }
                });
            });

            function showQuizSuccess(response) {
                const alert = $('<div class="alert alert-success alert-dismissible fade show mt-3">' +
                    '<i class="fas fa-check-circle"></i> Quiz completed! Score: ' + response.score + '%' +
                    (response.isCompleted ? ' - Module completed successfully!' : '') +
                    '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>' +
                    '</div>');

                $('.card-body').prepend(alert);
                setTimeout(() => alert.alert('close'), 5000);

                if (response.isCompleted) {
                    $('.progress-bar').css('background-color', '#28a745');
                }
            }

            // Initialize quiz section if videos already watched
            if (totalVideos === 1 && @Model.Progress.VideosWatched >= 1) {
                $('#quizSection').removeClass('d-none');
            }
        });
    </script>

    <style>
        .video-play-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.5);
            cursor: pointer;
            z-index: 10;
            transition: all 0.3s ease;
        }

            .video-play-overlay i {
                font-size: 4rem;
                color: white;
                transition: transform 0.3s ease;
            }

            .video-play-overlay:hover i {
                transform: scale(1.1);
            }

        #videoContainer {
            position: relative;
        }

        .custom-play-button {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 20;
        }
    </style>
}
@model PetCare_system.Models.Trainer

@{
    ViewBag.Title = "Trainer Dashboard";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<!-- Loading Animation CSS -->
<style>
    /* Loading Overlay */
    #loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.95);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        transition: opacity 0.5s ease;
    }

    .loader {
        width: 50px;
        height: 50px;
        border: 5px solid #f3f3f3;
        border-top: 5px solid #4e73df;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
    }

    .loading-text {
        color: #4e73df;
        font-size: 1.2rem;
        font-weight: 600;
        margin-top: 15px;
    }

    @@keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    /* Dashboard Styles */
    .dashboard-container {
        opacity: 0;
        transition: opacity 0.5s ease;
    }

    .dashboard-card {
        border-radius: 12px;
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.08);
        transition: all 0.3s ease;
        border: none;
        margin-bottom: 30px;
        overflow: hidden;
    }

    .welcome-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .profile-img {
        width: 110px;
        height: 110px;
        object-fit: cover;
        border: 4px solid rgba(255, 255, 255, 0.3);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
    }

    .specialization-badge {
        background-color: rgba(255, 255, 255, 0.2);
        color: white;
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 0.85rem;
        margin-right: 8px;
        margin-bottom: 8px;
        display: inline-block;
    }

    .action-card {
        border-left: 5px solid #4e73df;
    }

    .action-item {
        border: none;
        border-radius: 8px;
        margin-bottom: 12px;
        transition: all 0.2s;
        padding: 15px 20px;
    }

        .action-item:hover {
            background-color: #f8f9fc;
            transform: translateX(5px);
        }

    .logout-item {
        color: #e74a3b;
        background-color: rgba(231, 74, 59, 0.05);
    }

        .logout-item:hover {
            background-color: rgba(231, 74, 59, 0.1);
        }

    .feature-placeholder {
        background-color: #f8f9fe;
        border-radius: 10px;
        padding: 25px;
        text-align: center;
    }
</style>

<!-- Main Dashboard Content -->
<div class="container-fluid py-4">
    <!-- Navigation Bar -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card dashboard-card">
                <div class="card-body">
                    <div class="d-flex flex-wrap justify-content-center">
                        <a href="@Url.Action("Dashboard")" class="btn btn-outline-primary m-2">
                            <i class="fas fa-tachometer-alt mr-2"></i> Dashboard
                        </a>
                        <a href="@Url.Action("Profile")" class="btn btn-outline-primary m-2">
                            <i class="fas fa-user mr-2"></i> My Profile
                        </a>
                        <a href="@Url.Action("TrainerSessions", "Trainings")" class="btn btn-outline-primary m-2">
                            <i class="fas fa-calendar-alt mr-2"></i> Training Schedule
                        </a>
                        <a href="@Url.Action("Client")" class="btn btn-outline-primary m-2">
                            <i class="fas fa-users mr-2"></i> Client Management
                        </a>
                        <a href="@Url.Action("ModuleVideos", "TrainingContent", new { id = ViewBag.FirstModuleId })"
                           class="btn btn-outline-primary m-2 @(ViewBag.FirstModuleId == 0 ? "disabled" : "")">
                            <i class="fas fa-video mr-2"></i> Training Videos
                        </a>
                        <a href="@Url.Action("ModuleQuizzes", "TrainingContent", new { id = ViewBag.FirstModuleId })"
                           class="btn btn-outline-primary m-2 @(ViewBag.FirstModuleId == 0 ? "disabled" : "")">
                            <i class="fas fa-question-circle mr-2"></i> Training Quizzes
                        </a>
                        <a href="@Url.Action("Modules", "TrainingContent")" class="btn btn-outline-primary m-2">
                            <i class="fas fa-layer-group mr-2"></i> Training Modules
                        </a>
                        <a href="@Url.Action("TrainerDashboard","Trainings")" class="btn btn-outline-primary m-2">
                            <i class="fas fa-chart-line mr-2"></i> Progress Tracking
                        </a>
                        <a href="@Url.Action("Reports")" class="btn btn-outline-primary m-2">
                            <i class="fas fa-chart-bar mr-2"></i> Reports
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Welcome Card -->
    <div class="card dashboard-card welcome-card mb-4">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-2 text-center">
                    <img src="@(string.IsNullOrEmpty(Model?.ProfilePicture) ? "/Content/default-profile.png" : Model.ProfilePicture)"
                         class="profile-img img-circle" alt="Profile Picture">
                </div>
                <div class="col-md-10">
                    <h2 class="mb-3 font-weight-bold">Welcome back, @(Model?.FullName ?? "Trainer")!</h2>

                    @if (!string.IsNullOrEmpty(Model?.Specializations))
                    {
                        <div class="mb-3">
                            @foreach (var spec in Model.Specializations.Split(','))
                            {
                                <span class="specialization-badge">@spec.Trim()</span>
                            }
                        </div>
                    }

                    <p class="mb-2"><i class="fas fa-award mr-2"></i> @(Model?.YearsOfExperience ?? 0) years of experience</p>
                    <p class="mb-0">@(string.IsNullOrEmpty(Model?.Bio) ? "Complete your profile to share more about yourself." : Model.Bio)</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Row -->
    <div class="row">
        <!-- Account Management -->
        <div class="col-lg-6">
            <div class="card dashboard-card action-card h-100">
                <div class="card-header bg-white border-0">
                    <h5 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-user-cog mr-2"></i>Account Management
                    </h5>
                </div>
                <div class="card-body">
                    <div class="list-group list-group-flush">
                        <a href="@Url.Action("Profile")" class="list-group-item list-group-item-action action-item">
                            <i class="fas fa-user-edit mr-2"></i>View/Edit Profile
                            <i class="fas fa-chevron-right float-right mt-1"></i>
                        </a>
                        <a href="@Url.Action("ChangePassword", "TrainerAccount")" class="list-group-item list-group-item-action action-item">
                            <i class="fas fa-lock mr-2"></i>Change Password
                            <i class="fas fa-chevron-right float-right mt-1"></i>
                        </a>
                        <a href="javascript:void(0)" onclick="confirmLogout()" class="list-group-item list-group-item-action action-item logout-item">
                            <i class="fas fa-sign-out-alt mr-2"></i>Logout
                            <i class="fas fa-chevron-right float-right mt-1"></i>
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="col-lg-6">
            <div class="card dashboard-card h-100">
                <div class="card-header bg-white border-0">
                    <h5 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-bolt mr-2"></i>Quick Actions
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-around mb-3">
                        <a href="@Url.Action("Create", "Trainings")" class="btn btn-outline-primary">
                            <i class="fas fa-calendar-alt mr-2"></i>Schedule Session
                        </a>
                        <a href="@Url.Action("Clients")" class="btn btn-outline-primary">
                            <i class="fas fa-users mr-2"></i>View Clients
                        </a>
                        <a href="@Url.Action("Availability")" class="btn btn-outline-primary">
                            <i class="fas fa-clock mr-2"></i>Set Availability
                        </a>
                    </div>
                    

                </div>
            </div>
        </div>
    </div>
</div>


<!-- Client Reviews Card -->
<div class="col-md-4">
    <div class="card dashboard-card">
        <div class="card-body text-center">
            <i class="fas fa-star fa-3x text-warning mb-3"></i>
            <h3 id="average-rating">@(ViewBag.AverageRating?.ToString("0.0") ?? "0.0")</h3>
            <p class="text-muted">Average Rating</p>
            <div class="mt-2">
                @{
                    int rating = ViewBag.AverageRating != null ? (int)Math.Round((double)ViewBag.AverageRating) : 0;
                    for (int i = 1; i <= 5; i++)
                    {
                        if (i <= rating)
                        {
                            <i class="fas fa-star text-warning"></i>
                        }
                        else
                        {
                            <i class="far fa-star text-warning"></i>
                        }
                    }
                }
            </div>
            <div class="mt-3">
                <a href="@Url.Action("Reviews")" class="btn btn-sm btn-outline-warning">
                    View All Reviews
                </a>
            </div>
        </div>
    </div>
</div>



<!-- Video Call Modal -->
<div class="modal fade" id="videoCallModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fas fa-video mr-2"></i>Live Video Call</h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6 text-center">
                        <h6>You</h6>
                        <video id="localVideo" autoplay muted class="w-100 rounded"></video>
                        <div class="mt-2">
                            <button id="toggleVideoBtn" class="call-control-btn btn-success">
                                <i class="fas fa-video"></i>
                            </button>
                            <button id="toggleAudioBtn" class="call-control-btn btn-success">
                                <i class="fas fa-microphone"></i>
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6 text-center">
                        <h6>Pet Owner</h6>
                        <video id="remoteVideo" autoplay class="w-100 rounded"></video>
                        <div class="mt-2">
                            <button id="endCallBtn" class="call-control-btn btn-danger">
                                <i class="fas fa-phone-slash"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div id="callStatus" class="mt-3 alert alert-info text-center">
                    <i class="fas fa-spinner fa-spin mr-2"></i>Initializing call...
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Logout Form (hidden) -->
@using (Html.BeginForm("LogOff", "Account", FormMethod.Post, new { id = "logoutForm" }))
{
    @Html.AntiForgeryToken()
}

<!-- Required Libraries -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="~/Scripts/jquery.signalR-2.4.3.min.js"></script>
<script src="~/signalr/hubs"></script>

<script>
    // Global variables for video call
    let localStream;
    let peerConnection;
    let currentRoomId;
    let currentCallClientId;
    let localVideoEnabled = true;
    let localAudioEnabled = true;
    const videoHub = $.connection.videoHub;

    // Handle page load
    document.addEventListener('DOMContentLoaded', function () {
        // Load upcoming sessions
        loadUpcomingSessions();

        // Initialize SignalR connection
        initSignalR();
    });

    // Initialize SignalR connection
    function initSignalR() {
        // SignalR call handlers
        videoHub.client.callAccepted = function() {
            $('#callStatus').removeClass('alert-danger').addClass('alert-success')
                .html('<i class="fas fa-check-circle mr-2"></i>Call connected!');
            startVideoCall();
        };

        videoHub.client.callRejected = function(reason) {
            $('#callStatus').removeClass('alert-success').addClass('alert-danger')
                .html(`<i class="fas fa-times-circle mr-2"></i>Call declined: ${reason || 'No reason given'}`);
            $('#endCallBtn').click();
        };

        videoHub.client.receiveSignal = function(signal, senderId) {
            if (!peerConnection) return;

            if (signal.sdp) {
                peerConnection.setRemoteDescription(new RTCSessionDescription(signal.sdp))
                    .then(() => {
                        if (signal.sdp.type === 'answer') {
                            console.log('Received answer from pet owner');
                        } else if (signal.sdp.type === 'offer') {
                            return peerConnection.createAnswer()
                                .then(answer => peerConnection.setLocalDescription(answer))
                                .then(() => {
                                    videoHub.server.sendSignal(
                                        { type: 'answer', data: peerConnection.localDescription },
                                        currentRoomId
                                    );
                                });
                        }
                    });
            } else if (signal.ice) {
                peerConnection.addIceCandidate(new RTCIceCandidate(signal.ice));
            }
        };

        videoHub.client.callEnded = function() {
            endCall();
            $('#callStatus').removeClass('alert-success').addClass('alert-info')
                .html('<i class="fas fa-info-circle mr-2"></i>Pet owner ended the call');
        };

        // Start SignalR connection
        $.connection.hub.start().done(function() {
            console.log('SignalR connected');
            videoHub.server.joinRoom('trainer-lobby', 'Trainer');
        });
    }

    // Function to load upcoming sessions via AJAX
    function loadUpcomingSessions() {
        fetch('@Url.Action("GetUpcomingSessions", "Trainings")')
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('upcoming-sessions-list');

                if (data.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-3">
                            <i class="fas fa-calendar-times fa-2x text-muted mb-2"></i>
                            <p class="text-muted">No upcoming sessions</p>
                        </div>
                    `;
                    return;
                }

                let html = '';
                data.slice(0, 3).forEach(session => {
                    const date = new Date(session.sessionDate);
                    const formattedDate = date.toLocaleDateString('en-US', {
                        weekday: 'short',
                        month: 'short',
                        day: 'numeric'
                    });
                    const time = date.toLocaleTimeString('en-US', {
                        hour: '2-digit',
                        minute: '2-digit'
                    });

                    html += `
                        <div class="session-item">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <div class="session-time">${formattedDate} at ${time}</div>
                                    <div class="session-client">
                                        <i class="fas fa-user mr-1"></i> ${session.clientName}
                                    </div>
                                </div>
                                <div class="text-right">
                                    <span class="badge badge-primary">${session.sessionType}</span>
                                    <button class="btn btn-sm btn-success video-call-btn ml-2"
                                            data-session-id="${session.id}"
                                            data-client-id="${session.clientId}">
                                        <i class="fas fa-video"></i> Call
                                    </button>
                                </div>
                            </div>
                            <div class="session-service mt-1">
                                <i class="fas fa-paw mr-1"></i> ${session.petName} - ${session.serviceName}
                            </div>
                        </div>
                    `;
                });

                if (data.length > 3) {
                    html += `
                        <div class="text-center mt-2">
                            <small class="text-muted">+${data.length - 3} more sessions</small>
                        </div>
                    `;
                }

                container.innerHTML = html;

                // Attach event listeners to call buttons
                document.querySelectorAll('.video-call-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const sessionId = this.getAttribute('data-session-id');
                        const clientId = this.getAttribute('data-client-id');
                        startVideoCallSession(sessionId, clientId);
                    });
                });
            })
            .catch(error => {
                console.error('Error loading sessions:', error);
                container.innerHTML = `
                    <div class="text-center py-3 text-danger">
                        <i class="fas fa-exclamation-circle mr-2"></i>
                        Failed to load sessions
                    </div>
                `;
            });
    }

    // Start a video call session
    function startVideoCallSession(sessionId, clientId) {
        currentRoomId = `session-${sessionId}`;
        currentCallClientId = clientId;

        $('#videoCallModal').modal('show');
        $('#callStatus').removeClass('alert-danger alert-success').addClass('alert-info')
            .html('<i class="fas fa-spinner fa-spin mr-2"></i>Calling pet owner...');

        // Initialize call
        videoHub.server.initiateCall(currentCallClientId, currentRoomId);
    }

    // Start video call
    function startVideoCall() {
        navigator.mediaDevices.getUserMedia({ video: true, audio: true })
            .then(stream => {
                localStream = stream;
                $('#localVideo')[0].srcObject = stream;

                // Create peer connection
                peerConnection = new RTCPeerConnection({
                    iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
                });

                // Add local stream to connection
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });

                // Set up ICE candidate handler
                peerConnection.onicecandidate = ({ candidate }) => {
                    if (candidate) {
                        videoHub.server.sendSignal(
                            { type: 'ice', data: candidate },
                            currentRoomId
                        );
                    }
                };

                // Handle incoming stream
                peerConnection.ontrack = ({ streams }) => {
                    $('#remoteVideo')[0].srcObject = streams[0];
                };

                // Create offer
                peerConnection.createOffer()
                    .then(offer => peerConnection.setLocalDescription(offer))
                    .then(() => {
                        videoHub.server.sendSignal(
                            { type: 'offer', data: peerConnection.localDescription },
                            currentRoomId
                        );
                    });
            })
            .catch(err => {
                console.error('Error accessing media devices:', err);
                $('#callStatus').removeClass('alert-info').addClass('alert-danger')
                    .html('<i class="fas fa-exclamation-circle mr-2"></i>Error accessing camera/microphone');
            });
    }

    // End video call
    function endCall() {
        if (localStream) {
            localStream.getTracks().forEach(track => track.stop());
            $('#localVideo')[0].srcObject = null;
        }
        if (peerConnection) {
            peerConnection.close();
            peerConnection = null;
        }
        $('#remoteVideo')[0].srcObject = null;

        if (currentRoomId) {
            videoHub.server.endCall(currentRoomId);
        }
    }

    // Toggle video
    $('#toggleVideoBtn').click(function() {
        if (localStream) {
            const videoTracks = localStream.getVideoTracks();
            videoTracks.forEach(track => {
                track.enabled = !track.enabled;
                localVideoEnabled = track.enabled;
                $(this).toggleClass('btn-success btn-danger');
                $(this).find('i').toggleClass('fa-video fa-video-slash');
            });
        }
    });

    // Toggle audio
    $('#toggleAudioBtn').click(function() {
        if (localStream) {
            const audioTracks = localStream.getAudioTracks();
            audioTracks.forEach(track => {
                track.enabled = !track.enabled;
                localAudioEnabled = track.enabled;
                $(this).toggleClass('btn-success btn-danger');
                $(this).find('i').toggleClass('fa-microphone fa-microphone-slash');
            });
        }
    });

    // End call button
    $('#endCallBtn').click(function() {
        endCall();
        $('#videoCallModal').modal('hide');
    });

    // Clean up when modal closes
    $('#videoCallModal').on('hidden.bs.modal', function() {
        endCall();
    });

    // Logout confirmation
    function confirmLogout() {
        Swal.fire({
            title: 'Logout?',
            text: "Are you sure you want to sign out?",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#4e73df',
            cancelButtonColor: '#e74a3b',
            confirmButtonText: 'Yes, logout'
        }).then((result) => {
            if (result.isConfirmed) {
                // Show loading state
                Swal.fire({
                    title: 'Logging Out',
                    html: 'Please wait...',
                    timer: 2000,
                    timerProgressBar: true,
                    didOpen: () => {
                        Swal.showLoading();
                        setTimeout(() => {
                            document.getElementById('logoutForm').submit();
                        }, 1000);
                    }
                });
            }
        });
    }
</script>
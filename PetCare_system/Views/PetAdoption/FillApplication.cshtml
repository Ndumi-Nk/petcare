@model PetCare_system.Models.Pet_Adoption
@{
    ViewBag.Title = "Adoption Details";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h2>Complete Adoption Form</h2>

@using (Html.BeginForm())
{
    @Html.AntiForgeryToken()

    <div>
        <h4>Adopting: @Model.PetName (@Model.PetType)</h4>
    </div>

    <div class="form-group">
        @Html.LabelFor(m => m.ExperienceLevel)
        @Html.DropDownListFor(m => m.ExperienceLevel, (SelectList)ViewBag.ExperienceLevels, "Select", new { @class = "form-control" })
        @Html.ValidationMessageFor(m => m.ExperienceLevel)
    </div>

    <div class="form-group">
        @Html.LabelFor(m => m.HomeDescription)
        @Html.TextAreaFor(m => m.HomeDescription, new { @class = "form-control", rows = 4 })
        @Html.ValidationMessageFor(m => m.HomeDescription)

        <!-- Voice input button and status -->
        <button type="button" id="speakBtn" class="btn btn-outline-secondary mt-2">🎤 Speak</button>
        <small id="speechStatus" class="form-text text-muted"></small>
    </div>

    <div class="form-group">
        @Html.LabelFor(m => m.AdoptionReason)
        @Html.TextAreaFor(m => m.AdoptionReason, new { @class = "form-control", rows = 5 })
        @Html.ValidationMessageFor(m => m.AdoptionReason)

        <!-- Voice input button and status -->
        <button type="button" id="speakBtn" class="btn btn-outline-secondary mt-2">🎤 Speak</button>
        <small id="speechStatus" class="form-text text-muted"></small>
    </div>

    <div class="form-group">
        <label>
            @Html.CheckBoxFor(m => m.HasAgreedToTerms)
            I agree to the <a href="#">Terms and Conditions</a>.
        </label>
        @Html.ValidationMessageFor(m => m.HasAgreedToTerms)
    </div>

    <button type="submit" class="btn btn-primary">Submit Application</button>
}

<script>
     const speakBtn = document.getElementById("speakBtn");
     const specialNeedsTextArea = document.getElementById("specialNeeds");
     const statusText = document.getElementById("speechStatus");

     if (!('webkitSpeechRecognition' in window)) {
         statusText.textContent = "⚠️ Your browser doesn't support voice recognition. Use Google Chrome.";
         speakBtn.disabled = true;
     } else {
         const recognition = new webkitSpeechRecognition();
         recognition.continuous = false;
         recognition.interimResults = true;
         recognition.lang = 'en-US';

         let finalTranscript = '';

         recognition.onstart = () => {
             statusText.textContent = "🎙️ Listening...";
             finalTranscript = ''; // Reset between recognitions
         };

         recognition.onend = () => {
             statusText.textContent = "✅ Finished listening.";
             // Append only finalized text
             if (finalTranscript.trim()) {
                 specialNeedsTextArea.value += (specialNeedsTextArea.value ? " " : "") + finalTranscript.trim();
             }
         };

         recognition.onerror = (event) => {
             statusText.textContent = "❌ Error: " + event.error;
         };

         recognition.onresult = function (event) {
             finalTranscript = ''; // Reset in case onresult fires again unexpectedly

             for (let i = event.resultIndex; i < event.results.length; ++i) {
                 if (event.results[i].isFinal) {
                     finalTranscript += event.results[i][0].transcript;
                 }
             }
         };

         speakBtn.onclick = () => {
             recognition.start();
         };
     }
</script>
@model IEnumerable<PetCare_system.Models.VaccinationRecord>

@{
    ViewBag.Title = "Vaccination Records";
}

<!-- Load Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="hero-section">
    <div class="hero-content">
        <h1 class="display-4">Vaccination Records</h1>
        <p class="lead">Monitor your pet's vaccination status with insights and charts.</p>
        <p>
            @Html.ActionLink("Create New", "Create", null, new { @class = "btn btn-primary" })
        </p>
    </div>
</div>

<!-- Stylish Chart Section -->
<div class="container mt-5 mb-5">
    <div class="row justify-content-center">
        <div class="col-md-5">
            <div class="service-card text-center">
                <h4 class="mb-4">Overdue vs Up-to-Date</h4>
                <div style="max-width: 300px; margin: 0 auto;">
                    <canvas id="overdueChart" width="300" height="300"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-5">
            <div class="service-card text-center">
                <h4 class="mb-4">Vaccination Completion</h4>
                <div style="max-width: 300px; margin: 0 auto;">
                    <canvas id="completeChart" width="300" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

@*<div class="text-center mb-4">
    <p><strong>Voice Command Tip:</strong> Press <code>V</code> and say: <em>"Show pet names Samukelo"</em></p>
</div>*@

<!-- Vaccination Table -->
<div class="container">
    <table class="table table-striped table-bordered">
        <thead class="thead-dark">
            <tr>
                <th>@Html.DisplayNameFor(model => model.VaccineName)</th>
                <th>@Html.DisplayNameFor(model => model.VaccineType)</th>
                <th>@Html.DisplayNameFor(model => model.DateGiven)</th>
                <th>@Html.DisplayNameFor(model => model.NextDueDate)</th>
                <th>@Html.DisplayNameFor(model => model.Notes)</th>
                <th>Pet Name</th>
                <th>Is Overdue</th>
                <th>Days Until Next</th>
                <th>Vaccination Complete</th>
                <th>Month Given</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model)
            {
                <tr class="@(item.IsOverdue ? "table-danger" : "")">
                    <td>@Html.DisplayFor(modelItem => item.VaccineName)</td>
                    <td>@Html.DisplayFor(modelItem => item.VaccineType)</td>
                    <td>@Html.DisplayFor(modelItem => item.DateGiven)</td>
                    <td>@Html.DisplayFor(modelItem => item.NextDueDate)</td>
                    <td>@Html.DisplayFor(modelItem => item.Notes)</td>
                    <td>@item.Pet.Name</td>
                    <td>
                        @if (item.IsOverdue)
                        {
                            <span class="label label-danger">Yes</span>
                        }
                        else
                        {
                            <span class="label label-success">No</span>
                        }
                    </td>
                    <td>@item.DaysUntilNextDose</td>
                    <td>@(item.IsComplete ? "Yes" : "No")</td>
                    <td>@item.MonthGiven</td>
                    <td>
                        @Html.ActionLink("Edit", "Edit", new { id = item.VaccinationId }) |
                        @Html.ActionLink("Details", "Details", new { id = item.VaccinationId }) |
                        @Html.ActionLink("Delete", "Delete", new { id = item.VaccinationId })
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

<!-- Chart Script -->
@section Scripts {
    <script>
        var overdueCount = @Model.Count(x => x.IsOverdue);
        var upToDateCount = @Model.Count(x => !x.IsOverdue);
        var completeCount = @Model.Count(x => x.IsComplete);
        var incompleteCount = @Model.Count(x => !x.IsComplete);

        new Chart(document.getElementById('overdueChart').getContext('2d'), {
            type: 'doughnut',
            data: {
                labels: ['Overdue', 'Up-to-Date'],
                datasets: [{
                    data: [overdueCount, upToDateCount],
                    backgroundColor: ['#ff6b6b', '#28a745']
                }]
            },
            options: {
                plugins: { legend: { position: 'bottom' } }
            }
        });

        new Chart(document.getElementById('completeChart').getContext('2d'), {
            type: 'bar',
            data: {
                labels: ['Complete', 'Incomplete'],
                datasets: [{
                    label: 'Vaccination Completion',
                    data: [completeCount, incompleteCount],
                    backgroundColor: ['#007bff', '#ffc107']
                }]
            },
            options: {
                plugins: { legend: { display: false } },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { precision: 0 }
                    }
                }
            }
        });




        // Check browser support
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (SpeechRecognition) {
            const recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.lang = 'en-US';

            // Trigger recognition on a button click (you can trigger automatically too)
            document.addEventListener("keydown", function (e) {
                if (e.key === "v") { // Press 'v' to activate voice search
                    recognition.start();
                }
            });

            recognition.onresult = function (event) {
                const transcript = event.results[0][0].transcript.toLowerCase();
                console.log("Voice Command:", transcript);

                if (transcript.includes("show pet names")) {
                    const name = transcript.replace("show pet names", "").trim();
                    filterByPetName(name);
                }
            };

            recognition.onerror = function (event) {
                console.error("Speech recognition error:", event.error);
            };
        } else {
            alert("Your browser does not support speech recognition.");
        }

        function filterByPetName(petName) {
            const rows = document.querySelectorAll("table tbody tr");
            rows.forEach(row => {
                const nameCell = row.querySelector("td:nth-child(6)"); // 6th column is Pet Name
                if (nameCell && nameCell.textContent.toLowerCase().includes(petName.toLowerCase())) {
                    row.style.display = "";
                } else {
                    row.style.display = "none";
                }
            });
        }
    </script>
}

@model IEnumerable<PetCare_system.Models.Driver>

@{
    ViewBag.Title = "User Tracking Dashboard";
    var loggedInUserId = Session["LoggedInUserId"] != null
        ? Session["LoggedInUserId"].ToString()
        : string.Empty;
}

<!-- Import your custom style -->
<style>
    /* Base Styles */
    :root {
        --primary-color: #6C63FF;
        --secondary-color: #FF6584;
        --accent-color: #FFC107;
        --dark-color: #2D3748;
        --light-color: #F7FAFC;
        --success-color: #48BB78;
        --warning-color: #ED8936;
        --danger-color: #F56565;
        --info-color: #4299E1;
        --gradient-primary: linear-gradient(135deg, var(--primary-color) 0%, #8B7AFF 100%);
        --gradient-secondary: linear-gradient(135deg, var(--secondary-color) 0%, #FF8E9E 100%);
    }

    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        line-height: 1.6;
        color: var(--dark-color);
        background-color: #F8F9FA;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
    }

    /* Enhanced Loader */
    #loader {
        position: fixed;
        width: 100%;
        height: 100vh;
        background: var(--gradient-primary);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        transition: opacity 0.5s ease-out;
    }

    .loader-container {
        position: relative;
        width: 120px;
        height: 120px;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .loader-circle {
        position: absolute;
        width: 100%;
        height: 100%;
        border: 3px solid rgba(255, 255, 255, 0.1);
        border-radius: 50%;
        animation: rotate 3s linear infinite;
    }

        .loader-circle:nth-child(1) {
            border-bottom-color: rgba(255, 255, 255, 0.8);
            animation-delay: 0.1s;
        }

        .loader-circle:nth-child(2) {
            border-right-color: rgba(255, 255, 255, 0.6);
            animation-delay: 0.2s;
        }

        .loader-circle:nth-child(3) {
            border-top-color: rgba(255, 255, 255, 0.4);
            animation-delay: 0.3s;
        }

    .loader-icon {
        font-size: 48px;
        color: white;
        animation: pulse 1.5s ease-in-out infinite alternate;
    }

    .loader-text {
        margin-top: 20px;
        color: white;
        font-size: 16px;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 1px;
        animation: fadeInOut 2s ease-in-out infinite alternate;
    }

    .loader-progress {
        width: 180px;
        height: 4px;
        background: rgba(255, 255, 255, 0.2);
        margin-top: 15px;
        border-radius: 2px;
        overflow: hidden;
    }

    .loader-progress-bar {
        height: 100%;
        width: 0%;
        background: white;
        animation: progress 1.5s ease-in-out infinite;
    }

    /* Content Transition */
    .content {
        display: none;
        opacity: 0;
        transition: opacity 0.5s ease-in;
        flex: 1;
    }

        .content.show {
            opacity: 1;
        }

    /* Modern Navbar */
    .navbar {
        background: white;
        padding: 0.75rem 1rem;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        border-radius: 0;
        position: sticky;
        top: 0;
        z-index: 1030;
    }

    .navbar-brand {
        font-weight: 700;
        font-size: 1.5rem;
        color: var(--dark-color);
        display: flex;
        align-items: center;
    }

        .navbar-brand i {
            color: var(--primary-color);
            font-size: 1.75rem;
            margin-right: 0.5rem;
            transition: transform 0.3s ease;
        }

        .navbar-brand:hover i {
            transform: rotate(-15deg);
        }

    .navbar-nav .nav-link {
        position: relative;
        padding: 0.5rem 1rem;
        margin: 0 0.25rem;
        font-weight: 500;
        color: var(--dark-color) !important;
        border-radius: 6px;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
    }

        .navbar-nav .nav-link i {
            margin-right: 0.5rem;
            font-size: 1rem;
            width: 20px;
            text-align: center;
        }

        .navbar-nav .nav-link:hover,
        .navbar-nav .nav-link.active {
            background-color: rgba(108, 99, 255, 0.1);
            color: var(--primary-color) !important;
        }

        .navbar-nav .nav-link.active {
            font-weight: 600;
        }

            .navbar-nav .nav-link.active:after {
                content: '';
                position: absolute;
                bottom: 0;
                left: 50%;
                transform: translateX(-50%);
                width: 20px;
                height: 3px;
                background-color: var(--primary-color);
                border-radius: 3px;
            }

    /* Dropdown Menu */
    .dropdown-menu {
        border: none;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        border-radius: 8px;
        padding: 0.5rem 0;
        margin-top: 0.5rem;
    }

    .dropdown-item {
        padding: 0.5rem 1.25rem;
        font-weight: 500;
        color: var(--dark-color);
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
    }

        .dropdown-item i {
            margin-right: 0.75rem;
            color: var(--primary-color);
        }

        .dropdown-item:hover {
            background-color: rgba(108, 99, 255, 0.05);
            color: var(--primary-color);
            transform: translateX(3px);
        }

    .dropdown-divider {
        border-color: rgba(0, 0, 0, 0.05);
    }

    /* User Profile */
    .user-profile {
        display: flex;
        align-items: center;
        padding: 0.25rem 0.75rem;
        border-radius: 50px;
        transition: all 0.3s ease;
    }

        .user-profile:hover {
            background-color: rgba(108, 99, 255, 0.1);
        }

    .user-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        margin-right: 0.5rem;
        object-fit: cover;
        border: 2px solid var(--primary-color);
    }

    .user-name {
        font-weight: 500;
        margin-right: 0.5rem;
    }

    /* Auth Buttons */
    .auth-links .btn {
        margin-left: 0.5rem;
        font-weight: 500;
        border-radius: 6px;
        padding: 0.5rem 1rem;
    }

    .btn-primary {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
    }

        .btn-primary:hover {
            background-color: #5A52E0;
            border-color: #5A52E0;
        }

    .btn-outline-primary {
        color: var(--primary-color);
        border-color: var(--primary-color);
    }

        .btn-outline-primary:hover {
            background-color: rgba(108, 99, 255, 0.1);
            color: var(--primary-color);
        }

    /* Main Content */
    .container.body-content {
        padding: 2rem 0;
        flex: 1;
    }

    /* Cards */
    .card {
        border: none;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        margin-bottom: 1.5rem;
    }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

    .card-header {
        background-color: white;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        font-weight: 600;
        padding: 1rem 1.5rem;
        border-radius: 12px 12px 0 0 !important;
    }

    .card-body {
        padding: 1.5rem;
    }

    /* Forms */
    .form-control {
        border: 1px solid #E2E8F0;
        border-radius: 6px;
        padding: 0.75rem 1rem;
        transition: all 0.3s ease;
    }

        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.25rem rgba(108, 99, 255, 0.25);
        }

    .form-label {
        font-weight: 500;
        margin-bottom: 0.5rem;
    }

    /* Buttons */
    .btn {
        border-radius: 6px;
        font-weight: 500;
        padding: 0.625rem 1.25rem;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

        .btn i {
            margin-right: 0.5rem;
        }

    .btn-lg {
        padding: 0.75rem 1.5rem;
    }

    .btn-sm {
        padding: 0.375rem 0.75rem;
    }

    /* Alert Messages */
    .alert {
        border-radius: 8px;
        padding: 1rem 1.5rem;
        border: none;
    }

    .alert-success {
        background-color: rgba(72, 187, 120, 0.1);
        color: #2F855A;
    }

    .alert-danger {
        background-color: rgba(245, 101, 101, 0.1);
        color: #C53030;
    }

    .alert-info {
        background-color: rgba(66, 153, 225, 0.1);
        color: #2C5282;
    }

    /* Footer */
    footer {
        background-color: white;
        padding: 1.5rem;
        margin-top: 2rem;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
    }

        footer p {
            margin: 0.25rem 0;
            color: var(--dark-color);
            font-size: 0.9rem;
        }

        footer strong {
            color: var(--primary-color);
        }

    /* Utility Classes */
    .rounded-lg {
        border-radius: 12px;
    }

    .shadow-sm {
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .shadow-md {
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }

    /* Animations */
    @@keyframes rotate {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    @@keyframes pulse {
        0% {
            transform: scale(1);
            opacity: 0.8;
        }

        100% {
            transform: scale(1.1);
            opacity: 1;
        }
    }

    @@keyframes fadeInOut {
        0% {
            opacity: 0.6;
        }

        100% {
            opacity: 1;
        }
    }

    @@keyframes progress {
        0% {
            width: 0%;
            left: 0;
        }

        50% {
            width: 100%;
            left: 0;
        }

        100% {
            width: 0%;
            left: 100%;
        }
    }

    @@keyframes ripple {
        to {
            transform: scale(4);
            opacity: 0;
        }
    }

    /* Responsive Adjustments */
    @@media (max-width: 992px) {
        .navbar-nav {
            padding: 1rem 0;
        }

            .navbar-nav .nav-link {
                margin: 0.25rem 0;
                padding: 0.75rem 1rem;
            }

        .auth-links {
            margin-top: 1rem;
            margin-left: 0;
        }

        .user-dropdown {
            margin-left: 0;
            margin-top: 1rem;
        }
    }

    /* Pet-specific elements */
    .pet-avatar {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid white;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }

    .pet-status {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 50px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .status-healthy {
        background-color: rgba(72, 187, 120, 0.1);
        color: #2F855A;
    }

    .status-treatment {
        background-color: rgba(245, 158, 11, 0.1);
        color: #B7791F;
    }

    .status-critical {
        background-color: rgba(245, 101, 101, 0.1);
        color: #C53030;
    }

    /* Consultation cards */
    .consultation-card {
        border-left: 4px solid var(--primary-color);
        transition: all 0.3s ease;
    }

        .consultation-card:hover {
            border-left-width: 8px;
        }

    .consultation-date {
        font-size: 0.85rem;
        color: #718096;
    }

    .consultation-vet {
        font-weight: 600;
        color: var(--dark-color);
    }

    .consultation-notes {
        color: #4A5568;
        font-size: 0.9rem;
    }

    /* Loading state */
    .form-loading {
        position: relative;
    }

        .form-loading:after {
            content: "";
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            margin: -10px 0 0 -10px;
            border: 2px solid rgba(108, 99, 255, 0.3);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: none;
        }

        .form-loading.loading:after {
            display: block;
        }

    @@keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }
    /* Hide text by default */
    .nav-text {
        display: none;
        margin-left: 5px;
    }

    /* Show text on hover (desktop) */
    .nav-item:hover .nav-text {
        display: inline;
    }

    /* Show text on touch (mobile) */
    @@media (max-width: 991.98px) {
        .nav-text {
            display: inline !important;
        }
    }

    /* Alternative approach for touch devices */
    .nav-item:active .nav-text,
    .nav-item:focus .nav-text,
    .nav-item:focus-within .nav-text {
        display: inline;
    }
</style>

<!-- Mapbox CSS + JS -->
<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
<link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.1/mapbox-gl-directions.css" />
<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.1/mapbox-gl-directions.js"></script>

<div class="container body-content">
    <h2 class="mb-4">🚚 User Tracking Dashboard</h2>

    @if (!string.IsNullOrEmpty(loggedInUserId))
    {
        <!-- Tabs -->
        <ul class="nav nav-tabs mb-4" id="driverTabs">
            <li class="nav-item">
                <a class="nav-link active" data-bs-toggle="tab" href="#ecommerce"><i class="fa-solid fa-box"></i> E-Commerce</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#daycare"><i class="fa-solid fa-school"></i> Daycare</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#emergency"><i class="fa-solid fa-truck-medical"></i> Emergency</a>
            </li>
        </ul>

        <div class="tab-content">

            <!-- E-Commerce -->
            <div id="ecommerce" class="tab-pane fade show active">
                <div class="row">
                    @foreach (var driver in Model.Where(d => d.DriverType == "E-Commerce" && d.Userr_Id == loggedInUserId))
                    {
                        <div class="col-md-6 mb-4">
                            <div class="card shadow-sm">
                                <div class="card-header bg-light">
                                    <i class="fa-solid fa-box"></i> @driver.DriverName @driver.DriverSurname
                                </div>
                                <div class="card-body">
                                    <div id="map-@driver.DriverId" class="map-preview" style="height:250px;border-radius:12px;"></div>
                                    <p><strong>Destination:</strong> @driver.Destination</p>
                                    <p><strong>Status:</strong> <span class="pet-status status-treatment">@driver.Driverstatus</span></p>
                                    <button class="btn btn-primary btn-sm mt-2" onclick="viewLocation(@driver.DriverId)">📍 View Location</button>
                                    <button class="btn btn-success btn-sm mt-2" onclick="showRoute('@driver.DriverId', '@driver.Latitude','@driver.Longitude')">🗺 Show Route</button>
                                </div>
                            </div>
                        </div>
                        <script>
                            mapboxgl.accessToken = 'pk.eyJ1IjoiZWxpaGxlbzVvNSIsImEiOiJjbWVneGMzeXEwMXVsMmpxdHNuYWFjcnJ6In0.POHX_ByCgpihC2kRYQOyzw';
    var map = new mapboxgl.Map({
        container: 'map-@driver.DriverId',
        style: 'mapbox://styles/mapbox/streets-v11',
        center: [@driver.Longitude ?? 0, @driver.Latitude ?? 0],
        zoom: 13
    });

    var marker = new mapboxgl.Marker()
        .setLngLat([@driver.Longitude ?? 0, @driver.Latitude ?? 0])
        .setPopup(new mapboxgl.Popup().setHTML("<b>@driver.DriverName</b><br />@driver.DriverType Driver"))
        .addTo(map);
                        </script>

                    }
                </div>
            </div>

            <!-- Daycare -->
            <div id="daycare" class="tab-pane fade">
                <div class="row">
                    @foreach (var driver in Model.Where(d => d.DriverType == "Daycare" && d.Userr_Id == loggedInUserId))
                    {
                        <div class="col-md-6 mb-4">
                            <div class="card shadow-sm">
                                <div class="card-header bg-light">
                                    <i class="fa-solid fa-school"></i> @driver.DriverName @driver.DriverSurname
                                </div>
                                <div class="card-body">
                                    <div id="map-@driver.DriverId" class="map-preview" style="height:250px;border-radius:12px;"></div>
                                    <p><strong>Address:</strong> @driver.Destination</p>
                                    <p><strong>Pet:</strong> @driver.Pet_Id</p>
                                    <p><strong>Status:</strong> <span class="pet-status status-treatment">@driver.Driverstatus</span></p>
                                </div>


                            </div>
                        </div>
                        <script>
    mapboxgl.accessToken = 'pk.eyJ1IjoiZWxpaGxlbzVvNSIsImEiOiJjbWVneGMzeXEwMXVsMmpxdHNuYWFjcnJ6In0.POHX_ByCgpihC2kRYQOyzw';

    const lat = @driver.Latitude ?? null;
    const lng = @driver.Longitude ?? null;
    const address = "@driver.Destination";
    const mapContainer = 'map-@driver.DriverId';

    if (lat && lng && (lat !== 0 && lng !== 0)) {
        const map = new mapboxgl.Map({
            container: mapContainer,
            style: 'mapbox://styles/mapbox/streets-v11',
            center: [lng, lat],
            zoom: 13
        });

        new mapboxgl.Marker()
            .setLngLat([lng, lat])
            .setPopup(new mapboxgl.Popup().setHTML("<b>@driver.DriverName</b><br />@driver.DriverType Driver"))
            .addTo(map);
    } else {
        fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(address)}.json?access_token=${mapboxgl.accessToken}`)
            .then(response => response.json())
            .then(data => {
                const coords = data.features[0]?.center;
                if (!coords) return;

                const map = new mapboxgl.Map({
                    container: mapContainer,
                    style: 'mapbox://styles/mapbox/streets-v11',
                    center: coords,
                    zoom: 13
                });

                new mapboxgl.Marker()
                    .setLngLat(coords)
                    .setPopup(new mapboxgl.Popup().setHTML("<b>@driver.DriverName</b><br />@driver.DriverType Driver"))
                    .addTo(map);
            });
    }
                        </script>
                    }
                </div>
            </div>

            <!-- Emergency -->
            <div id="emergency" class="tab-pane fade">
                <div class="row">
                    @foreach (var driver in Model.Where(d => d.DriverType == "Emergency" && d.Userr_Id == loggedInUserId))
                    {
                        <div class="col-md-6 mb-4">
                            <div class="card shadow-sm border-danger">
                                <div class="card-header bg-danger text-white">
                                    <i class="fa-solid fa-truck-medical"></i> @driver.DriverName
                                </div>
                                <div class="card-body">
                                    <div id="map-@driver.DriverId" class="map-preview" style="height:250px;border-radius:12px;"></div>
                                    <p><strong>Destination:</strong> @driver.Destination</p>
                                    <p><strong>Status:</strong> <span class="pet-status status-critical">@driver.Driverstatus</span></p>
                                </div>
                            </div>
                        </div>
                        <script>
                            mapboxgl.accessToken = 'pk.eyJ1IjoiZWxpaGxlbzVvNSIsImEiOiJjbWVneGMzeXEwMXVsMmpxdHNuYWFjcnJ6In0.POHX_ByCgpihC2kRYQOyzw';
    var map = new mapboxgl.Map({
        container: 'map-@driver.DriverId',
        style: 'mapbox://styles/mapbox/streets-v11',
        center: [@driver.Longitude ?? 0, @driver.Latitude ?? 0],
        zoom: 13
    });

    var marker = new mapboxgl.Marker()
        .setLngLat([@driver.Longitude ?? 0, @driver.Latitude ?? 0])
        .setPopup(new mapboxgl.Popup().setHTML("<b>@driver.DriverName</b><br />@driver.DriverType Driver"))
        .addTo(map);
                        </script>
                    }
                </div>
            </div>

        </div>
    }
    else
    {
        <div class="alert alert-danger">⚠️ Please log in to view your drivers.</div>
    }
</div>

<script>
    window.driverMaps = {};
    window.driverMarkers = {};
    window.driverRoutes = {};

    document.addEventListener("DOMContentLoaded", function () {
        mapboxgl.accessToken = 'pk.eyJ1IjoiZWxpaGxlbzVvNSIsImEiOiJjbWVneGMzeXEwMXVsMmpxdHNuYWFjcnJ6In0.POHX_ByCgpihC2kRYQOyzw';
    });

    function viewLocation(driverId) {
        let map = driverMaps[driverId], marker = driverMarkers[driverId];
        if (map && marker) {
            map.flyTo({ center: marker.getLngLat(), zoom: 15 });
            marker.togglePopup();
        }
    }

    function liveTrack(driverId) {
        let map = driverMaps[driverId];
        let marker = driverMarkers[driverId];
        if (!map || !marker) return;

        const startLat = -29.8586804, startLng = 31.0218404;
        marker.setLngLat([startLng, startLat]);
        map.setCenter([startLng, startLat]);
        map.setZoom(14);

        if (marker.liveInterval) clearInterval(marker.liveInterval);

        marker.liveInterval = setInterval(() => {
            fetch(`/Drivers/GetDriverLocation?id=${driverId}`)
                .then(r => r.json())
                .then(data => {
                    if (!data || !data.Latitude || !data.Longitude) return;
                    marker.setLngLat([parseFloat(data.Longitude), parseFloat(data.Latitude)]);
                });
        }, 5000);
    }

    function showRoute(driverId, lat, lng) {
        let map = driverMaps[driverId];
        if (!map || !lat || !lng || lat === "null" || lng === "null") return;

        let startLat = -29.8586804, startLng = 31.0218404;
        if (driverRoutes[driverId]) map.removeControl(driverRoutes[driverId]);

        driverRoutes[driverId] = new MapboxDirections({
            accessToken: mapboxgl.accessToken,
            unit: "metric",
            profile: "mapbox/driving",
            interactive: false,
            controls: { inputs: false, instructions: false }
        });

        map.addControl(driverRoutes[driverId]);
        driverRoutes[driverId].setOrigin([startLng, startLat]);
        driverRoutes[driverId].setDestination([lng, lat]);
    }

    function getDirections(lat, lng) {
        if (!lat || !lng || lat === "null" || lng === "null") return;
        let start = encodeURIComponent("82 Diakonia Avenue, Durban");
        window.open(`https://www.google.com/maps/dir/?api=1&origin=${start}&destination=${lat},${lng}`, "_blank");
    }

    // Fix: Resize maps when switching tabs
    document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll('a[data-bs-toggle="tab"]').forEach(tab => {
            tab.addEventListener("shown.bs.tab", function () {
                for (let id in driverMaps) {
                    driverMaps[id].resize();
                }
            });
        });
    });
</script>

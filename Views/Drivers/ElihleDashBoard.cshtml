@model IEnumerable<PetCare_system.Models.Driver>

@{
    ViewBag.Title = "Driver Dashboard";
}

<!-- Mapbox CSS + JS -->
<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

<!-- Mapbox Directions -->
<link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.1/mapbox-gl-directions.css" />
<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.1/mapbox-gl-directions.js"></script>

<style>
    body {
        background: #f9fafb;
        font-family: 'Segoe UI', sans-serif;
        margin: 0;
    }

    /* Hero */
    .hero-section {
        background: linear-gradient(135deg, #4b6cb7, #182848);
        color: #fff;
        text-align: center;
        padding: 3rem 1rem;
    }

        .hero-section h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .hero-section p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

    /* Dashboard */
    .dashboard-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 2rem;
        padding: 2rem;
        max-width: 1400px;
        margin: auto;
    }

    .driver-card {
        background: #fff;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        padding: 1.5rem;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

        .driver-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
        }

    .map-preview {
        width: 100%;
        height: 40vh;
        border-radius: 12px;
        margin-bottom: 1rem;
    }

    .directions-panel {
        max-height: 200px;
        overflow-y: auto;
        margin-bottom: 1rem;
        padding: 1rem;
        background: #f4f6f9;
        border-radius: 12px;
        font-size: 0.9rem;
        line-height: 1.4;
        box-shadow: inset 0 0 6px rgba(0,0,0,0.1);
    }

    .driver-info h2 {
        font-size: 1.25rem;
        font-weight: bold;
        margin-bottom: 0.3rem;
    }

    .driver-info p {
        margin: 0.2rem 0;
        font-size: 0.95rem;
    }

    .btn-group {
        display: flex;
        flex-wrap: wrap;
        gap: 0.6rem;
        margin-top: 1rem;
    }

    .btn-action {
        flex: 1;
        padding: 0.6rem;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.9rem;
        font-weight: 600;
        transition: all 0.25s ease;
        text-align: center;
    }

    .status-patient {
        background: #27ae60; /* Emerald Green */
        animation: pulse 1.5s infinite;
    }

    /* Subtle glowing animation */
    keyframes pulse {
        0%

    {
        box-shadow: 0 0 0 0 rgba(39,174,96,0.7);
    }

    70% {
        box-shadow: 0 0 0 10px rgba(39,174,96,0);
    }

    100% {
        box-shadow: 0 0 0 0 rgba(39,174,96,0);
    }

    }


    .btn-location {
        background: #4b6cb7;
        color: #fff;
    }

    .btn-track {
        background: #e63946;
        color: #fff;
    }

    .btn-directions {
        background: #2ecc71;
        color: #fff;
    }

    .btn-status {
        background: #f39c12;
        color: #fff;
    }

    .btn-action:hover {
        filter: brightness(1.1);
        transform: translateY(-2px);
    }

    .status-btns {
        margin-top: 1rem;
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }
</style>

<section class="hero-section">
    <h1>Welcome, @ViewBag.DriverName</h1>
    <p>Your live delivery dashboard</p>
</section>

<section class="dashboard-container">
    @foreach (var item in Model)
    {
        <div class="driver-card">
            <div id="map-@item.DriverId" class="map-preview"></div>

            <!-- Directions Panel -->
            <div id="directions-@item.DriverId" class="directions-panel"></div>

            <div class="driver-info">
                <h2>@item.DriverName — @item.DriverType Driver</h2>
                <p><strong>Status:</strong> @item.Driverstatus</p>
                <p><strong>Destination:</strong> @item.Destination</p>

                <p><strong>License Number:</strong> @item.License</p>
                <p><strong>Car Information:</strong> @item.CarInfo</p>
            </div>

            <div class="btn-group">
                <button class="btn-action btn-location" onclick="viewLocation(@item.DriverId)">📍 View Location</button>
                <button class="btn-action btn-track" onclick="liveTrack(@item.DriverId)">📡 Live Tracking</button>
                <button class="btn-action btn-directions" onclick="showRoute('@item.DriverId', '@item.Latitude','@item.Longitude')">🗺 Show Route</button>
                <button class="btn-action btn-directions" onclick="getDirections('@item.Latitude','@item.Longitude')">🌍 Google Maps</button>
            </div>

            @if (item.DriverType == "Ecommerce")
            {
                <div class="status-btns">
                    @using (Html.BeginForm("UpdateDeliveryStatus", "Drivers", FormMethod.Post))
                    {
                        @Html.Hidden("driverId", item.DriverId)
                        <button type="submit" name="status" value="Picked Up" class="btn-action btn-status">✅ Picked Up</button>
                        <button type="submit" name="status" value="In Transit" class="btn-action btn-status">🚚 In Transit</button>
                        <button type="submit" name="status" value="Delivered" class="btn-action btn-status">📦 Delivered</button>
                    }
                </div>
            }
            <div class="status-btns">
                @using (Html.BeginForm("StartDriving", "Drivers", FormMethod.Post))
                {
                    @Html.Hidden("driverId", item.DriverId)
                    <button type="submit" class="btn-action btn-status">🚘 Start Driving</button>
                }
            </div>
            <div class="status-btns">
                @using (Html.BeginForm("PatientDelivered", "Drivers", FormMethod.Post))
                {
                    @Html.Hidden("driverId", item.DriverId)
                    <button type="submit" class="btn-action btn-status">🚑 Patient Delivered</button>
                }
            </div>
        </div>

        <script>
            mapboxgl.accessToken = 'pk.eyJ1IjoiZWxpaGxlbzVvNSIsImEiOiJjbWVneGMzeXEwMXVsMmpxdHNuYWFjcnJ6In0.POHX_ByCgpihC2kRYQOyzw';

            var map = new mapboxgl.Map({
                container: 'map-@item.DriverId',
                style: 'mapbox://styles/mapbox/streets-v11',
                center: [@((item.Longitude ?? "0")), @((item.Latitude ?? "0"))],
                zoom: 13
            });

            var marker = new mapboxgl.Marker()
                .setLngLat([@((item.Longitude ?? "0")), @((item.Latitude ?? "0"))])
                .setPopup(new mapboxgl.Popup().setHTML("<b>@item.DriverName</b><br />@item.DriverType Driver"))
                .addTo(map);

            window.driverMaps = window.driverMaps || {};
            window.driverMarkers = window.driverMarkers || {};
            window.driverRoutes = window.driverRoutes || {};
            driverMaps[@item.DriverId] = map;
            driverMarkers[@item.DriverId] = marker;
        </script>
    }
</section>

<script>
    function viewLocation(driverId) {
        let map = driverMaps[driverId], marker = driverMarkers[driverId];
        if (map && marker) {
            map.flyTo({ center: marker.getLngLat(), zoom: 15 });
            marker.togglePopup();
        } else alert("Location not available");
    }

    function liveTrack(driverId) {
        let map = driverMaps[driverId];
        let marker = driverMarkers[driverId];
        if (!map || !marker) return alert("No location available for this driver");

        alert("Live tracking started for Driver " + driverId);

        // Start at 82 Diakonia Avenue
        const startLat = -29.8586804;
        const startLng = 31.0218404;

        // Move marker to start point and zoom map there
        marker.setLngLat([startLng, startLat]);
        map.setCenter([startLng, startLat]);
        map.setZoom(14);

        // Clear previous interval if exists
        if (marker.liveInterval) clearInterval(marker.liveInterval);

        // Update marker every 5 seconds with the driver's actual location
        marker.liveInterval = setInterval(() => {
            fetch(`/Drivers/GetDriverLocation?id=${driverId}`)
                .then(response => response.json())
                .then(data => {
                    if (!data || !data.Latitude || !data.Longitude) return;

                    let lat = parseFloat(data.Latitude);
                    let lng = parseFloat(data.Longitude);

                    // Move marker to new driver location without moving the map
                    marker.setLngLat([lng, lat]);
                })
                .catch(err => console.error("Error fetching driver location:", err));
        }, 5000);
    }

    function showRoute(driverId, lat, lng) {
        let map = driverMaps[driverId];
        if (!map || !lat || !lng || lat === "null" || lng === "null") {
            return alert("Destination not available");
        }

        let startLat = -29.8586804, startLng = 31.0218404; // Durban: 82 Diakonia Avenue

        if (driverRoutes[driverId]) {
            map.removeControl(driverRoutes[driverId]);
        }

        driverRoutes[driverId] = new MapboxDirections({
            accessToken: mapboxgl.accessToken,
            unit: 'metric',
            profile: 'mapbox/driving',
            interactive: false,
            controls: { inputs: false, instructions: false }
        });

        map.addControl(driverRoutes[driverId]);

        let panel = document.getElementById("directions-" + driverId);
        driverRoutes[driverId].on('route', (e) => {
            if (e.route && e.route[0]) {
                let steps = e.route[0].legs[0].steps;
                let html = "<h4>Directions</h4><ol>";
                steps.forEach(step => {
                    html += `<li>${step.maneuver.instruction}</li>`;
                });
                html += "</ol>";
                panel.innerHTML = html;
            }
        });

        driverRoutes[driverId].setOrigin([startLng, startLat]);
        driverRoutes[driverId].setDestination([lng, lat]);
    }

    function getDirections(lat, lng) {
        if (!lat || !lng || lat === "null" || lng === "null") return alert("Location not available");
        let start = encodeURIComponent("82 Diakonia Avenue, Durban");
        window.open(`https://www.google.com/maps/dir/?api=1&origin=${start}&destination=${lat},${lng}`, "_blank");
    }
</script>
